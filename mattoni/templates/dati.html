{% extends 'base.html' %}
{% load static %}

{% block title %}Scheda Intervento{% endblock %}

{% block content %}

<!-- Navbar -->
<nav class="navbar navbar-expand-sm bg-light navbar-light">
    <ul class="navbar-nav ml-auto">
        <li class="nav-item">
            <div class="container m-auto p-3">
                <a class="navbar-brand" href="#">
                  <img
                    src="https://mdbcdn.b-cdn.net/img/logo/mdb-transaprent-noshadows.webp"
                    height="20"
                    alt="MDB Logo"
                    loading="lazy"
                  />
                </a>
            </div>
        </li>

        <li class="nav-item">
            <div class="container p-3">
                <h3>{{request.user.corporation}}</h3>
            </div>
        </li>
        
        <li class="nav-item">
            <div class="container-fluid">
                <ul class="navbar-nav">
                  <!-- Avatar -->
                  <li class="nav-item dropdown">
                    <a
                      class="nav-link dropdown-toggle d-flex align-items-center"
                      href="#"
                      id="navbarDropdownMenuLink"
                      role="button"
                      data-mdb-toggle="dropdown"
                      aria-expanded="false"
                    >
                      <img
                        src="https://mdbcdn.b-cdn.net/img/Photos/Avatars/img (31).webp"
                        class="square"
                        height="50"
                        alt="Personale Image"
                        loading="lazy"
                      />
                    </a>
                    <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                      <li>
                        <a class="dropdown-item" href="{% url 'operativo' %}">Home</a>
                      </li>
                      <li>
                        <a class="dropdown-item" href="{% url 'dati' %}">I miei dati</a>
                      </li>
                      <li>
                        <a class="dropdown-item" href="{% url 'protocolli' %}">Protocolli</a>
                      </li>
                      <li>
                        <a class="dropdown-item" href="{% url 'gestione_missioni' %}">Missioni</a>
                      </li>
                      <li>
                        <a class="dropdown-item" href="{% url 'dati_mezzo' %}">Dati mezzo</a>
                      </li>
                      <li>
                        <a class="dropdown-item" href="{% url 'logout' %}">Logout</a>
                      </li>
                    </ul>
                  </li>
                </ul>
            </div>
        </li>

    </ul>
</nav>

<div class="container mt-5 text-center bg-white">
  <h1 class="m-3">Dati personali</h1>
</div>

<div class="container pt-2 ps-5 pe-5" >
  {% if messages %}
  <ul class="alert alert-info text-center" style="list-style: none;">
      {% for message in messages %}
      <li{% if message.tags %} class="{{ message.tags }}" {% endif %}>{{ message }}</li>
      {% endfor %}
  </ul>
  {% endif %}
  <div class="p-5 pb-3 m-0 bg-light">
    <div class="col-12 d-flex flex-column" >

      <ul class="list-unstyled font-small m-4 " >
        <!-- MIGLIORA -->
        <li>
          <form class="md-form">
            <div class="file-field ">
              <div class="mb-4 d-flex justify-content-end">
                <img src="https://mdbootstrap.com/img/Photos/Others/placeholder-avatar.webp"
                  class="rounded-circle z-depth-1-half avatar-pic" style="width: 150px" alt="example placeholder avatar">
              </div>
              <div class="d-flex justify-content-end">
                <div class="btn btn-mdb-color btn-rounded float-left">
                  <span>Add photo</span>
                  <input type="file">
                </div>
              </div>
            </div>
          </form>
        </li>
        

        <li>
          <p class="text-uppercase mb-2"><strong>Nome e Cognone</strong></p>
          <p class="text-muted mb-4">{{ request.user.first_name }} {{ request.user.last_name }}</p>
        </li>

        <li>
          <p class="text-uppercase mb-2"><strong>Username</strong></p>
          <p class="text-muted mb-4">{{ request.user.username }}</p>
        </li>

        <li>
          <p class="text-uppercase mb-2"><strong>Associazione</strong></p>
          <p class="text-muted mb-4">{{ request.user.corporation }}</p>
        </li>

        <li>
          <p class="text-uppercase mb-2"><strong>Email</strong></p>
          <p class="text-muted mb-4">{{ request.user.email }}</p>
        </li>

        <li>
          <p class="text-uppercase mb-2"><strong>Cellulare</strong></p>
          <p class="text-muted mb-4">{{ request.user.phone }}</p>
        </li>
        <li>
            <div class="container p-5 d-flex justify-content-end">
              <button type="button" class="btn btn-primary btn-lg" data-mdb-toggle="modal" data-mdb-target="#modificautente" id="modalbutton">
                Modifica
            </button>
            </div>
        </li>
      
      </ul>

    </div>
    
    
  </div>
</div>

<div class="modal fade" id="modificautente" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Modifica dati</h5>
              <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center">
              <form class="text-center" id="modifica_dati" method="post"> 
                  {% csrf_token %}
                  <p class="slogan">Inserisci tutti i dati con le modifiche che vuoi apportare:</p>
              
                  <div class='text-center'>
                      <ul class="alert alert-danger" id='errors' style="list-style: none;" hidden>
                          
                      </ul>
                  </div>

                  <!-- Nome e Cognome -->
                  <div class="row mb-4">
                    <div class="col">
                      <div class="form-outline">
                        <input type="text" id="name" class="form-control" value="{{request.user.first_name}}" name="first_name" required oninvalid="this.setCustomValidity('Inserisci il nome')" oninput="setCustomValidity('')">
                        <label class="form-label" for="name">Nome</label>
                      </div>
                    </div>
                    <div class="col">
                      <div class="form-outline">
                        <input type="text" id="last_name" class="form-control" value="{{request.user.last_name}}" name="last_name"required oninvalid="this.setCustomValidity('Inserisci il cognome')" oninput="setCustomValidity('')">
                        <label class="form-label" for="last_name">Cognome</label>
                      </div>
                    </div>
                  </div>

                  <!-- Username -->
                  <div class="form-outline mb-4">
                    <input type="text" id="username" class="form-control" value="{{request.user.username}}" name="username"required oninvalid="this.setCustomValidity('Scegli uno username')" oninput="setCustomValidity('')">
                    <label class="form-label" for="username">Username</label>
                  </div>

                  <!-- Email -->
                  <div class="form-outline mb-4">
                    <input type="email" id="email" class="form-control" value="{{request.user.email}}" name="email"required oninvalid="this.setCustomValidity('Inserisci email')" oninput="setCustomValidity('')">
                    <label class="form-label" for="email">Email</label>
                  </div>
                  

                  <!-- Numero Telefono -->
                  <div class="form-outline mb-4">
                    <input type="tel" id="phone" class="form-control" value="{{request.user.phone}}" name="phone" required oninvalid="this.setCustomValidity('Inserisci il numero di cellulare')" oninput="setCustomValidity('')">
                    <label class="form-label" for="phone">Cellulare</label>
                  </div>

                  <!-- Associazione -->
                  <div class="form-outline mb-4">
                    <input type="text" id="corporation" class="form-control" value="{{request.user.corporation}}" name="corporation" required oninvalid="this.setCustomValidity('Inserisci associazione di appartenenza')" oninput="setCustomValidity('')">
                    <label class="form-label" for="corporation">Associazione</label>
                  </div>

                  </div>
                  <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">Annulla</button>
                      <button type="submit" id="invio_post" class="btn btn-primary">Conferma</button>
                  </div>
                  
              </form>
          
      </div>
  </div>
</div>

{% endblock %}
{% block scripts %}
<script>
  $(document).ready(function () {
      var token = '{{ csrf_token }}';
  
  
      $('#invio_post').click(function (e) {
          e.preventDefault();
          formData = $('#modifica_dati').serialize();
          
          
            $.ajax({
                headers: {
                    "X-CSRFToken": token,
                },
                url: '{% url "modifica_dati" %}',
                dataType: 'json', 
                type: 'POST',
                data: formData,
                success: function (result) {
                    if(result['status']=='error'){
                          $('#errors').empty();
                          errors = result['errors']
                          for(const item in errors)
                          {
                              $('#errors').removeAttr('hidden');
                              $("#errors").prepend('<p>'+errors[item]+'</p>');
                          }
                  }
                  else{
                      window.location = '{% url "dati" %}'
                  }
                },
  
            });
          
  
  
  
    });
  
});
</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.css" />
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>
<script src="{% static 'js/functions.js' %}"></script>
{% endblock %}